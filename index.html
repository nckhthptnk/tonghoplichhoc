<!doctype html>
<html lang="vi">
 <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tổng hợp dữ liệu A/B → Xuất PNG</title>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    :root { 
      --bg: #f7f7fb; 
      --card: #ffffff; 
      --muted: #6b7280; 
      --ink: #111827; 
      --line: #e5e7eb;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
    }
    
    * { box-sizing: border-box; }
    
    html, body { height: 100%; }
    
    body { 
      margin: 0; 
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; 
      background: var(--bg); 
      color: var(--ink); 
      line-height: 1.5;
    }
    
    .wrap { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 24px 16px; 
      min-height: 100%;
    }
    
    .card { 
      background: var(--card); 
      border: 1px solid var(--line); 
      border-radius: 16px; 
      box-shadow: 0 2px 8px rgba(0,0,0,.04); 
      margin-bottom: 24px;
    }
    
    .row { 
      display: flex; 
      gap: 24px; 
      flex-wrap: wrap; 
      margin-bottom: 24px;
    }
    
    .col { 
      flex: 1 1 360px; 
    }
    
    h1 { 
      font-size: 28px; 
      margin: 0 0 8px; 
      font-weight: 700;
      color: var(--ink);
    }
    
    h2 { 
      font-size: 20px; 
      margin: 0 0 16px; 
      font-weight: 600;
      color: var(--ink);
    }
    
    .muted { 
      color: var(--muted); 
      font-size: 14px; 
      margin: 8px 0;
    }
    
    .section { 
      padding: 24px; 
    }
    
    .btn { 
      padding: 12px 20px; 
      border-radius: 10px; 
      border: 1px solid var(--line); 
      background: #fff; 
      cursor: pointer; 
      font-weight: 600; 
      font-size: 14px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      background: #f9fafb;
      border-color: var(--muted);
    }
    
    .btn.primary { 
      background: var(--primary); 
      color: #fff; 
      border-color: var(--primary); 
    }
    
    .btn.primary:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .badge { 
      font-size: 12px; 
      padding: 4px 8px; 
      border-radius: 6px; 
      background: #eef2ff; 
      color: #3730a3; 
      border: 1px solid #c7d2fe; 
      font-weight: 500;
    }
    
    .badge.success {
      background: #f0fdf4;
      color: #166534;
      border-color: #bbf7d0;
    }
    
    .badge.warning {
      background: #fffbeb;
      color: #92400e;
      border-color: #fde68a;
    }
    
    .grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 16px; 
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
    }
    
    input[type="text"], input[type="file"], textarea { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid var(--line); 
      border-radius: 10px; 
      background: #fff; 
      font-family: inherit; 
      font-size: 14px;
      transition: border-color 0.2s ease;
    }
    
    input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .data-preview { 
      background: #f9fafb; 
      border: 1px solid var(--line); 
      border-radius: 10px; 
      padding: 16px; 
      min-height: 120px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 16px;
    }
    
    th, td { 
      border: 1px solid var(--line); 
      padding: 12px; 
      text-align: left; 
      font-size: 14px; 
      vertical-align: top; 
    }
    
    th { 
      background: #f3f4f6; 
      font-weight: 600;
    }
    
    #export-area { 
      background: #fff; 
      padding: 32px; 
      border: 2px dashed var(--line); 
      border-radius: 16px; 
      margin-top: 24px;
    }
    
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .file-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }
    
    .stat-card {
      background: #f8fafc;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .row {
        flex-direction: column;
      }
      
      .wrap {
        padding: 16px 12px;
      }
      
      .section {
        padding: 16px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="wrap">
   <div class="section" style="padding-bottom:0">
    <h1 id="app-title">Tổng hợp dữ liệu từ 2 trang → Xuất PNG</h1>
    <p class="muted" id="description-text">Nhận dữ liệu qua <code>postMessage</code> từ 2 nguồn (whitelist), xem trước &amp; xuất ảnh PNG (client-only).</p>
   </div>
   <div class="row">
    <div class="col card section">
     <h2>1) Whitelist nguồn</h2>
     <div class="grid">
      <div><label id="origin1-label">Origin 1</label> <input id="origin1" type="text" value="https://nckhthptnk.github.io">
      </div>
      <div><label id="origin2-label">Origin 2</label> <input id="origin2" type="text" value="https://tkbnkhoahung.github.io">
      </div>
     </div>
     <div class="status-indicator">
      <div class="status-dot"></div><span class="badge" id="listen-badge">Đang lắng nghe postMessage</span> <button class="btn" id="resetBtn">Xóa dữ liệu nhận</button>
     </div>
     <p class="muted">Nhấn "Gửi sang Tổng hợp" trên A/B để đẩy dữ liệu qua đây.</p>
    </div>
    <div class="col card section">
     <h2>2) Nạp thủ công (fallback)</h2>
     <div class="file-input-wrapper"><input type="file" id="file1" accept="application/json"> <span class="badge">lichtrinhcanhan.json</span>
     </div>
     <div class="file-input-wrapper"><input type="file" id="file2" accept="application/json"> <span class="badge">tkbnk2526hs.json</span>
     </div>
     <p class="muted">Nếu không chèn script vào nguồn, xuất JSON và nạp tại đây.</p>
    </div>
   </div>
   <div class="card section">
    <h2>3) Dữ liệu đã nhận</h2>
    <div class="summary-stats">
     <div class="stat-card">
      <div class="stat-number" id="source1-count">
       0
      </div>
      <div class="stat-label">
       Nguồn 1 - Bản ghi
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="source2-count">
       0
      </div>
      <div class="stat-label">
       Nguồn 2 - Bản ghi
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="total-count">
       0
      </div>
      <div class="stat-label">
       Tổng cộng
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="last-updated">
       --
      </div>
      <div class="stat-label">
       Cập nhật cuối
      </div>
     </div>
    </div>
    <div class="data-preview" id="dataPreview">
     Chưa có dữ liệu nào được nhận...
    </div>
   </div>
   <div class="card section">
    <h2>4) Xuất PNG</h2>
    <p class="muted">Khu vực bên dưới sẽ được chụp và xuất thành file PNG.</p>
    <div style="display: flex; gap: 12px; margin-bottom: 16px;"><button class="btn primary" id="exportBtn">
      <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /> <polyline points="7,10 12,15 17,10" /> <line x1="12" y1="15" x2="12" y2="3" />
      </svg><span id="export-button-text">Xuất PNG</span> </button> <button class="btn" id="previewBtn">Xem trước</button>
    </div>
    <div id="export-area">
     <h2 style="text-align: center; margin-bottom: 24px;">Báo cáo tổng hợp dữ liệu</h2>
     <div id="export-content">
      <p style="text-align: center; color: var(--muted);">Chưa có dữ liệu để hiển thị</p>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Configuration object for editable features
    const defaultConfig = {
      app_title: "Tổng hợp dữ liệu từ 2 trang → Xuất PNG",
      description_text: "Nhận dữ liệu qua postMessage từ 2 nguồn (whitelist), xem trước & xuất ảnh PNG (client-only).",
      origin1_label: "Origin 1",
      origin2_label: "Origin 2", 
      export_button_text: "Xuất PNG"
    };

    // Data storage
    let receivedData = {
      source1: null,
      source2: null,
      lastUpdated: null
    };

    // DOM elements
    const elements = {
      origin1: document.getElementById('origin1'),
      origin2: document.getElementById('origin2'),
      resetBtn: document.getElementById('resetBtn'),
      file1: document.getElementById('file1'),
      file2: document.getElementById('file2'),
      dataPreview: document.getElementById('dataPreview'),
      exportBtn: document.getElementById('exportBtn'),
      previewBtn: document.getElementById('previewBtn'),
      exportArea: document.getElementById('export-area'),
      exportContent: document.getElementById('export-content'),
      source1Count: document.getElementById('source1-count'),
      source2Count: document.getElementById('source2-count'),
      totalCount: document.getElementById('total-count'),
      lastUpdated: document.getElementById('last-updated')
    };

    // Initialize postMessage listener
    function initPostMessageListener() {
      window.addEventListener('message', (event) => {
        const origin1 = elements.origin1.value.trim();
        const origin2 = elements.origin2.value.trim();
        
        if (event.origin !== origin1 && event.origin !== origin2) {
          console.warn('Rejected message from unauthorized origin:', event.origin);
          return;
        }

        try {
          const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
          
          if (event.origin === origin1) {
            receivedData.source1 = data;
          } else if (event.origin === origin2) {
            receivedData.source2 = data;
          }
          
          receivedData.lastUpdated = new Date();
          updateDisplay();
          
        } catch (error) {
          console.error('Error processing received data:', error);
        }
      });
    }

    // File upload handlers
    function setupFileHandlers() {
      elements.file1.addEventListener('change', (e) => handleFileUpload(e, 'source1'));
      elements.file2.addEventListener('change', (e) => handleFileUpload(e, 'source2'));
    }

    function handleFileUpload(event, source) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          receivedData[source] = data;
          receivedData.lastUpdated = new Date();
          updateDisplay();
        } catch (error) {
          alert('Lỗi đọc file JSON: ' + error.message);
        }
      };
      reader.readAsText(file);
    }

    // Update display functions
    function updateDisplay() {
      updatePreview();
      updateStats();
      updateExportContent();
    }

    function updatePreview() {
      const preview = {
        source1: receivedData.source1,
        source2: receivedData.source2,
        lastUpdated: receivedData.lastUpdated?.toLocaleString('vi-VN')
      };
      
      elements.dataPreview.textContent = JSON.stringify(preview, null, 2);
    }

    function updateStats() {
      const count1 = receivedData.source1 ? (Array.isArray(receivedData.source1) ? receivedData.source1.length : 1) : 0;
      const count2 = receivedData.source2 ? (Array.isArray(receivedData.source2) ? receivedData.source2.length : 1) : 0;
      
      elements.source1Count.textContent = count1;
      elements.source2Count.textContent = count2;
      elements.totalCount.textContent = count1 + count2;
      elements.lastUpdated.textContent = receivedData.lastUpdated ? 
        receivedData.lastUpdated.toLocaleTimeString('vi-VN') : '--';
    }

    function updateExportContent() {
      if (!receivedData.source1 && !receivedData.source2) {
        elements.exportContent.innerHTML = '<p style="text-align: center; color: var(--muted);">Chưa có dữ liệu để hiển thị</p>';
        return;
      }

      let html = '<div style="margin-bottom: 24px;">';
      
      if (receivedData.lastUpdated) {
        html += `<p style="text-align: center; color: var(--muted); margin-bottom: 16px;">Cập nhật: ${receivedData.lastUpdated.toLocaleString('vi-VN')}</p>`;
      }

      // Summary table
      html += '<table style="margin-bottom: 24px;"><thead><tr><th>Nguồn</th><th>Số bản ghi</th><th>Trạng thái</th></tr></thead><tbody>';
      
      const count1 = receivedData.source1 ? (Array.isArray(receivedData.source1) ? receivedData.source1.length : 1) : 0;
      const count2 = receivedData.source2 ? (Array.isArray(receivedData.source2) ? receivedData.source2.length : 1) : 0;
      
      html += `<tr><td>Nguồn 1</td><td>${count1}</td><td>${receivedData.source1 ? '✅ Có dữ liệu' : '❌ Chưa có'}</td></tr>`;
      html += `<tr><td>Nguồn 2</td><td>${count2}</td><td>${receivedData.source2 ? '✅ Có dữ liệu' : '❌ Chưa có'}</td></tr>`;
      html += `<tr style="font-weight: bold;"><td>Tổng cộng</td><td>${count1 + count2}</td><td>-</td></tr>`;
      html += '</tbody></table>';

      // Data preview
      if (receivedData.source1) {
        html += '<h3>Dữ liệu nguồn 1:</h3>';
        html += `<pre style="background: #f9fafb; padding: 12px; border-radius: 8px; font-size: 12px; overflow-x: auto;">${JSON.stringify(receivedData.source1, null, 2)}</pre>`;
      }

      if (receivedData.source2) {
        html += '<h3>Dữ liệu nguồn 2:</h3>';
        html += `<pre style="background: #f9fafb; padding: 12px; border-radius: 8px; font-size: 12px; overflow-x: auto;">${JSON.stringify(receivedData.source2, null, 2)}</pre>`;
      }

      html += '</div>';
      elements.exportContent.innerHTML = html;
    }

    // Export functionality
    async function exportToPNG() {
      try {
        elements.exportBtn.disabled = true;
        elements.exportBtn.innerHTML = '<span>Đang xuất...</span>';

        const canvas = await html2canvas(elements.exportArea, {
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true,
          allowTaint: true
        });

        const link = document.createElement('a');
        link.download = `data-summary-${new Date().toISOString().slice(0, 10)}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

      } catch (error) {
        console.error('Export error:', error);
        alert('Lỗi xuất PNG: ' + error.message);
      } finally {
        elements.exportBtn.disabled = false;
        updateExportButtonText();
      }
    }

    function updateExportButtonText() {
      const config = window.elementSdk?.config || defaultConfig;
      elements.exportBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7,10 12,15 17,10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        <span>${config.export_button_text}</span>
      `;
    }

    // Reset functionality
    function resetData() {
      receivedData = {
        source1: null,
        source2: null,
        lastUpdated: null
      };
      updateDisplay();
    }

    // Event listeners
    function setupEventListeners() {
      elements.resetBtn.addEventListener('click', resetData);
      elements.exportBtn.addEventListener('click', exportToPNG);
      elements.previewBtn.addEventListener('click', () => {
        elements.exportArea.scrollIntoView({ behavior: 'smooth' });
      });
    }

    // Element SDK integration
    async function onConfigChange(config) {
      // Update text content
      document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('description-text').textContent = config.description_text || defaultConfig.description_text;
      document.getElementById('origin1-label').textContent = config.origin1_label || defaultConfig.origin1_label;
      document.getElementById('origin2-label').textContent = config.origin2_label || defaultConfig.origin2_label;
      
      updateExportButtonText();
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["app_title", config.app_title || defaultConfig.app_title],
        ["description_text", config.description_text || defaultConfig.description_text],
        ["origin1_label", config.origin1_label || defaultConfig.origin1_label],
        ["origin2_label", config.origin2_label || defaultConfig.origin2_label],
        ["export_button_text", config.export_button_text || defaultConfig.export_button_text]
      ]);
    }

    // Initialize application
    function init() {
      initPostMessageListener();
      setupFileHandlers();
      setupEventListeners();
      updateDisplay();
      
      // Initialize Element SDK if available
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
      }
    }

    // Start the application
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9968f9f5706d859d',t:'MTc2MTgwNzAwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
